name: 'RPM Build'
description: 'Build RPMs from spec file and upload it as Artifact or Release Asset'
author: 'Grigory Efimov'

inputs:
  platform:
    description: 'Build target architecture (e.g., linux/amd64, linux/arm64)'
    required: false
    default: 'linux/amd64'
  docker-image:
    description: 'Docker image (e.g amazonlinux:2, ubuntu:latest)'
    required: false
    default: 'amazonlinux:2'
  pre-build-command:
    description: 'Pre build command (e.g yum install -y rpmdevtools'
    required: false
    default: 'yum install -y rpm-build rpmdevtools gcc make coreutils python git rsync yum-utils GeoIP-devel'

runs:
  using: 'composite'
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ inputs.platform }}

    - name: build on ${{ inputs.docker-image }} platform=${{ inputs.platform }}
      shell: bash
      run: |
        docker run \
          --platform ${{ inputs.platform }} \
          --rm \
          --volume ${{ github.workspace }}:/workspace \
          --volume ${{ github.action_path }}:/action_path \
          --workdir /workspace \
          ${{ inputs.docker-image }} \
          /bin/bash -lc '
            set -euxo pipefail
            uname -a

            tar --version
            python3 - <<"PY"
            import os,platform
            print(platform.machine())
            print(os.uname())
            PY
            mkdir -p /workspace/rpmbuild/BUILD/ok_test/auto && echo OK

            # change topdir for build
            mkdir -p /workspace/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
            printf "%%_topdir /workspace/rpmbuild\n" > /root/.rpmmacros

            # run build
            ${{ inputs.pre-build-command }}
            /action_path/build.sh
          '

branding:
  icon: 'package'
  color: 'red'
